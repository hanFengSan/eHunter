# Feature Specification: Gallery Download Bundle

**Feature Branch**: `001-gallery-download-bundle`  
**Created**: 2026-02-22  
**Status**: Draft  
**Input**: User description: "DownloadConfirmDialog中点击确定时，触发下载功能，要求如下：包含图片打包下载、YAML元信息、进度状态通知、分片压缩、失败重试与换源策略。"

## Clarifications

### Session 2026-02-22

- Q: 下载失败时“2次重试”的计数方式是什么？ → A: 初次请求失败后再重试 2 次（总计最多 3 次尝试）。

## User Scenarios & Testing *(mandatory)*

**Validation Note**: For each completed development cycle, run `npm run dev` and verify changed behavior in browser using `chrome-devtools-mcp` before marking work complete.

### User Story 1 - 一键下载画廊压缩包 (Priority: P1)

作为阅读器用户，我在下载确认弹窗点击确定后，系统按页顺序抓取画廊图片并下载为一个或多个压缩包，每个压缩包都包含图片和元信息文件，便于离线保存与归档。

**Why this priority**: 这是核心业务价值，若无法稳定导出离线包，本功能整体无意义。

**Independent Test**: 在有 20-50 页的画廊中触发下载，验证下载产物可打开，图片按页码命名且 YAML 信息完整。

**Acceptance Scenarios**:

1. **Given** 用户打开 DownloadConfirmDialog 且画廊可访问, **When** 用户点击确定, **Then** 系统开始顺序下载图片并最终触发压缩包下载。
2. **Given** 图片下载成功, **When** 压缩包生成后, **Then** 压缩包内图片文件名按页码零填充编号（如 `001.jpg`、`002.webp`）且扩展名与图片格式一致。
3. **Given** 画廊页数超过单包分片阈值, **When** 下载完成, **Then** 系统触发多个分片压缩包下载，每个分片均包含对应 YAML 文件。

---

### User Story 2 - 实时可见下载进度 (Priority: P2)

作为用户，我希望在页面右下角看到清晰的下载状态通知，实时了解当前进度、压缩阶段和结果，以避免误判卡死或重复点击。

**Why this priority**: 下载链路较长且网络波动常见，透明进度可显著降低困惑和重复操作。

**Independent Test**: 触发一次下载并在过程中观察通知区域，验证多个通知可同时展示、位置正确、内容实时更新。

**Acceptance Scenarios**:

1. **Given** 用户已触发下载, **When** 系统进入拉取与压缩流程, **Then** 右下角悬浮通知显示当前阶段（例如进行到第 X/Y 张、正在压缩、完成/失败）。
2. **Given** 同时存在多个状态事件, **When** 通知展示, **Then** 通知在 status-pannel 上方垂直排列且互不覆盖。

---

### User Story 3 - 网络异常下的稳健下载 (Priority: P3)

作为用户，我希望在图片请求失败时系统自动重试并在配置允许时执行换源兜底，从而提高整包下载成功率。

**Why this priority**: 网络与源站不稳定是高频场景，可靠性决定用户是否愿意长期使用下载功能。

**Independent Test**: 模拟部分图片请求失败，验证每次失败会执行最多 2 次网络重试，并按配置执行换源重试后再回退原图加载路径。

**Acceptance Scenarios**:

1. **Given** 某张图片请求失败, **When** 自动换源重试配置开启, **Then** 系统先尝试换源重试，若仍失败再尝试原图加载，并对每次网络请求在初次失败后最多重试 2 次（单次请求链路最多 3 次尝试）。
2. **Given** 某张图片最终仍失败, **When** 下载流程继续, **Then** 系统记录该失败状态并在通知中反馈，不应导致整个任务无提示中断。

---

### Edge Cases

- 当画廊总页数为 0 或解析结果为空时，系统应立即终止下载并提示无可下载内容。
- 当画廊标题包含跨平台非法文件名字符时，系统应自动清洗为合法名称后再生成压缩包。
- 当分片大小被设置为非正数或异常值时，系统应回退到默认分片大小 200。
- 当下载过程中页面被切换模式或用户继续浏览时，通知状态应保持可见且不中断任务状态反馈。
- 当同一会话触发多次下载任务时，通知区域应能并行显示各任务状态，不发生覆盖或错位。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统 MUST 在 DownloadConfirmDialog 点击确定后启动下载任务，并按画廊页码顺序逐张处理图片。
- **FR-002**: 系统 MUST 将下载图片写入压缩包，图片文件名使用固定宽度零填充页码编号，最小宽度为 3 位（例如 `001`、`045`、`300`）。
- **FR-003**: 系统 MUST 保留每张图片的实际格式扩展名（如 `.jpg`、`.webp`），不得统一强制转换格式。
- **FR-004**: 系统 MUST 在每个压缩包中写入一个 YAML 元信息文件，至少包含：intro HTML URL、画廊标题、画廊总页数、下载时间、eHunter 版本号。
- **FR-005**: 系统 MUST 支持下载分片配置项，默认值为 200；当总页数超过分片大小时，系统必须按顺序拆分为多个压缩包下载。
- **FR-006**: 系统 MUST 在分片下载模式下，于 YAML 元信息中新增并填写总分片数量与当前分片索引。
- **FR-007**: 系统 MUST 使用画廊标题作为压缩包名称基础，并在生成文件名前执行跨平台非法字符清洗，确保在 Windows、macOS、Linux 上可保存。
- **FR-008**: 系统 MUST 提供通用状态通知组件，悬浮于页面右下角且位于 status-pannel 上方，支持多个通知同时显示并垂直排列。
- **FR-009**: 系统 MUST 通过状态通知实时反馈下载进度与阶段，包括但不限于：当前处理页数/总页数、正在压缩、下载完成、下载失败。
- **FR-010**: 系统 MUST 控制单任务内存占用，避免一次性聚合超大画廊全部图片数据；当触发分片规则时，必须以分片为单位完成打包与释放。
- **FR-011**: 系统 MUST 在每次网络请求初次失败后执行最多 2 次重试（即单次请求链路最多 3 次尝试）后再判定失败。
- **FR-012**: 系统 MUST 在自动换源重试配置开启时，按“换源重试 -> 原图加载”顺序执行兜底获取；配置关闭时仅走原始获取链路。
- **FR-013**: 系统 MUST 在部分图片失败时继续处理后续页面，并在最终结果与通知中明确失败数量与原因摘要。
- **FR-014**: 系统 MUST 确保状态通知组件视觉风格清晰、美观、易读，并在桌面与移动视口下保持可辨识与不遮挡关键操作区。

### Key Entities *(include if feature involves data)*

- **Download Task**: 一次由用户确认触发的完整下载流程，包含画廊上下文、进度状态、失败统计、开始与结束时间。
- **Download Chunk**: 按分片大小切分后的打包单元，包含分片索引、分片内页码范围、分片图片集合、分片级 YAML 元信息。
- **Image Item**: 单页图片下载对象，包含页码、目标文件名、来源地址、请求结果、重试次数与最终状态。
- **Status Notification**: 用于前端展示任务状态的通知实体，包含任务标识、状态类型、展示文案、时间戳、可见性状态。
- **Gallery Metadata YAML**: 随压缩包导出的元信息文档，记录画廊基础信息、下载时间、版本号及分片上下文信息。

### Assumptions

- 下载时间以用户本地时间写入 YAML，格式保持可读且可解析。
- 分片索引从 1 开始计数，总分片数量在任务开始后可确定。
- 当无法获取某张图片时，允许该分片继续打包已成功图片，同时输出失败记录。

### Dependencies

- 依赖现有画廊图片地址解析能力与阅读器中的下载确认入口。
- 依赖现有可配置项体系以新增“下载分片大小”和“自动换源重试开关”读取能力。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 在 300 页画廊、默认分片 200 的场景下，用户一次点击可获得 2 个可正常解压的下载包，且每包都包含 YAML 元信息文件。
- **SC-002**: 95% 的正常网络下载任务可在触发后 1 秒内出现首条状态通知，并在任务结束时给出明确完成或失败结果。
- **SC-003**: 在包含 10% 随机图片请求失败的测试场景中，启用自动换源重试后，整任务成功下载图片占比达到 98% 及以上。
- **SC-004**: 在并发触发 3 个下载任务时，通知区域可同时展示 3 组状态信息，用户可明确区分各任务进度且无明显重叠遮挡。
- **SC-005**: 用户抽样检查下载产物时，100% 的图片文件名符合页码编号规则且与对应页码一一匹配。
