# Feature Specification: PageView Magnifier Menu

**Feature Branch**: `001-add-pageview-magnifier`  
**Created**: 2026-02-24  
**Status**: Draft  
**Input**: User description: "为PageView增加放大镜功能支持，支持在滚动/书页模式下通过不同手势打开菜单，并提供放大镜开关、倍率调整、加载原图与奇偶切换等操作。"

## Clarifications

### Session 2026-02-24

- Q: 放大镜是否在移动端可用？ → A: 仅桌面端可用；移动端菜单不显示放大镜相关项。
- Q: 切换到新 PageView 后放大镜状态如何处理？ → A: 会话内跨页继承放大镜开关状态与当前倍率。
- Q: 移动端长按触发阈值是多少？ → A: 固定 500ms。
- Q: 平台不支持换源刷新时，“加载原图”如何呈现？ → A: 菜单项保留但置灰禁用并显示不支持原因。
- Q: 书页模式用于打开菜单的中央区域如何定义？ → A: 与现有书页模式“中间留白区”定义完全一致。

## User Scenarios & Testing *(mandatory)*

**Validation Note**: For each completed development cycle, run `npm run dev` and verify changed behavior in browser using `chrome-devtools-mcp` before marking work complete.

### User Story 1 - 快速打开页面菜单 (Priority: P1)

作为阅读中的用户，我希望在不同阅读模式下都能用符合设备习惯的手势快速打开页面菜单，这样我无需离开当前页面即可执行关键操作。

**Why this priority**: 菜单入口是所有后续能力（放大镜、加载原图、奇偶切换）的前提，若无法稳定打开，功能整体不可用。

**Independent Test**: 在滚动模式与书页模式中分别触发对应手势，验证菜单是否在预期条件下弹出，并且不会误触发与模式冲突的翻页行为。

**Acceptance Scenarios**:

1. **Given** 用户处于滚动模式且使用桌面端设备，**When** 单击当前图片区域，**Then** 页面菜单在当前 PageView 上弹出。
2. **Given** 用户处于滚动模式且使用移动端设备，**When** 对当前图片持续按压达到 500ms，**Then** 页面菜单在当前 PageView 上弹出。
3. **Given** 用户处于书页模式，**When** 点击与现有书页模式“中间留白区”定义一致且覆盖到 PageView 的位置，**Then** 打开页面菜单且不触发上下翻页。

---

### User Story 2 - 使用放大镜查看细节 (Priority: P2)

作为桌面端阅读中的用户，我希望能在当前 PageView 内开启放大镜并调整倍率，以便快速查看局部细节而不改变整体阅读进度。

**Why this priority**: 放大镜是本需求的核心价值，直接提升细节查看体验，且不应影响主阅读流程。

**Independent Test**: 在桌面端菜单中开启放大镜后移动鼠标，验证放大镜与焦点框显示、倍率切换、边界避让与仅作用于当前 PageView 的行为；在移动端验证不展示放大镜相关项。

**Acceptance Scenarios**:

1. **Given** 放大镜关闭，**When** 用户从菜单选择“打开放大镜”，**Then** 放大镜在当前 PageView 生效，菜单文案切换为“关闭放大镜”。
2. **Given** 放大镜已开启，**When** 用户移动鼠标，**Then** 鼠标焦点位置显示 80x80 的半透明白色参考框，并显示不遮挡鼠标的正方形放大镜框。
3. **Given** 放大镜显示在鼠标右侧会超出 PageView 边界，**When** 鼠标继续移动到边缘区域，**Then** 放大镜自动切换到另一侧并保持在 PageView 可视边界内。
4. **Given** 放大镜已开启且当前倍率为 3x，**When** 用户执行“增大放大镜倍率”或“缩小放大镜倍率”，**Then** 倍率仅在 2x/3x/4x/5x 间切换并实时生效。
5. **Given** 用户在同一阅读会话中切换到新的 PageView，**When** 新页面渲染完成，**Then** 放大镜开关状态与当前倍率沿用上一页面设置。

---

### User Story 3 - 按上下文显示菜单操作 (Priority: P3)

作为阅读中的用户，我希望菜单只展示当前场景可执行的操作，避免无效按钮和错误预期。

**Why this priority**: 上下文化菜单可降低误操作，提升功能可理解性与操作效率。

**Independent Test**: 在不同模式与平台能力下打开菜单，验证“加载原图”“奇偶切换”“倍率调整”等操作是否按条件显隐且可执行。

**Acceptance Scenarios**:

1. **Given** 当前平台支持换源刷新，**When** 打开页面菜单，**Then** 菜单显示“加载原图”操作并可触发原图加载。
2. **Given** 当前平台不支持换源刷新，**When** 打开页面菜单，**Then** 菜单保留“加载原图”操作但处于禁用状态，并显示不可用原因说明。
3. **Given** 当前为书页模式，**When** 打开页面菜单，**Then** 菜单显示“奇偶切换”操作；在滚动模式下不显示该操作。
4. **Given** 桌面端且放大镜关闭，**When** 打开菜单，**Then** 菜单不显示倍率调整操作；放大镜开启后显示“增大放大镜倍率”和“缩小放大镜倍率”。
5. **Given** 移动端设备，**When** 打开页面菜单，**Then** 菜单不显示放大镜开关与倍率调整操作。

### Edge Cases

- 用户在滚动模式移动端执行短按、滑动或点击时，不应误触发长按菜单（按压不足 500ms 不触发）。
- 移动端不应出现放大镜开关或倍率操作入口，避免提供不可执行功能。
- 平台不支持换源刷新时，“加载原图”应保持禁用且不可触发实际加载。
- 用户在书页模式点击非中央留白区域时，应保持原有翻页交互，不弹出菜单。
- 放大镜开启后鼠标离开当前 PageView 时，放大镜与焦点框应立即隐藏。
- 当前倍率已在最小值 2x 时执行“缩小”，或在最大值 5x 时执行“增大”，系统应保持边界值且给出可感知的无变化反馈（例如按钮不可用或无动作）。
- 跨页继承开启状态时，若新页面图片尚未可用，应延迟显示放大镜内容直到图片可被放大。
- 图片尚未加载完成或加载失败时，菜单仍可打开，但放大镜区域应显示可理解的占位状态而非错误内容。
- 当 PageView 靠近容器边缘（左/右/上/下）时，放大镜仍需完整可见并避免遮挡鼠标焦点。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须在滚动模式下提供页面菜单入口：桌面端通过单击图片触发，移动端通过长按图片触发，且长按阈值固定为 500ms。
- **FR-002**: 系统必须在书页模式下仅允许通过与现有书页模式“中间留白区”定义一致的区域内、且命中 PageView 的点击来打开页面菜单，并保留该模式下非中央区域的现有翻页行为。
- **FR-003**: 页面菜单必须仅在桌面端包含“打开放大镜/关闭放大镜”单一切换项，文案需与当前放大镜状态一致；移动端不得显示该项。
- **FR-004**: 放大镜功能必须仅作用于触发菜单的当前 PageView 实例，不得影响其他页面视图。
- **FR-005**: 放大镜默认倍率必须为 3x，允许倍率必须且仅为 2x、3x、4x、5x，且该能力仅适用于桌面端。
- **FR-006**: 在桌面端，当放大镜开启时菜单必须显示“增大放大镜倍率”和“缩小放大镜倍率”；当放大镜关闭时菜单不得显示这两项；移动端不得显示这两项。
- **FR-007**: 放大镜必须以正方形框显示，采用主题绿色边框与阴影样式，并默认显示在鼠标右侧且不遮挡鼠标焦点。
- **FR-008**: 当放大镜在默认侧会超出当前 PageView 边界时，系统必须自动切换至另一侧或可用位置，确保放大镜完全处于 PageView 可视范围内。
- **FR-009**: 放大镜开启且鼠标位于 PageView 内时，系统必须在焦点处显示 80px x 80px 的白色半透明参考框，以标识当前放大区域；移动端不显示该参考框。
- **FR-010**: 页面菜单必须始终展示“加载原图”操作；当平台支持换源刷新时该操作可用，当平台不支持时该操作必须置灰禁用并提供不可用原因说明。
- **FR-011**: 用户触发“加载原图”后，当前 PageView 必须改为使用原图源进行加载。
- **FR-012**: 页面菜单必须仅在书页模式下显示“奇偶切换”操作，在滚动模式下不得显示。
- **FR-013**: 放大镜、焦点框和菜单的显示/隐藏必须跟随当前 PageView 的交互上下文变化（如离开视图、模式切换、关闭菜单），避免残留在页面上。
- **FR-014**: 在同一阅读会话内，用户切换 PageView 后系统必须继承上一页面的放大镜开关状态与倍率设置；默认初始值仍为关闭 + 3x。

### Key Entities *(include if feature involves data)*

- **PageView Interaction Context**: 表示当前用户交互所绑定的页面视图实例与阅读模式，关键属性包括模式类型、输入设备类型、是否命中中央菜单区域。
- **Page Menu Action Set**: 表示菜单可展示操作集合，关键属性包括操作名称、可见条件、可执行条件。
- **Magnifier State**: 表示放大镜状态，关键属性包括开关状态、当前倍率（2/3/4/5）、显示位置、边界避让结果。
- **Magnifier Session Preference**: 表示会话级放大镜偏好，关键属性包括是否开启、当前倍率、适用范围（当前阅读会话）。
- **Focus Indicator**: 表示放大焦点参考框，关键属性包括尺寸（80x80）、显示状态、当前位置、透明度等级。

## Assumptions

- “透明白色（大约305透明度）”按产品意图解释为“约 30% 不透明度的白色覆盖层”。
- 放大镜倍率切换以相邻档位递增/递减方式进行，每次操作变更 1 档。
- “加载原图”仅针对当前 PageView 正在展示的图片生效，不批量作用于其他页面。
- 放大镜状态继承仅限同一阅读会话，不作为长期持久化设置。

## Dependencies

- 菜单需依赖已存在的“平台是否支持换源刷新”能力判断结果。
- 书页模式菜单触发区域直接复用现有“中间留白区”定义，以与全局翻页手势进行冲突规避。
- PageView 需能够识别当前输入环境（桌面端/移动端）与基础指针事件。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 在可用性验收中，90% 以上测试参与者可在 3 秒内通过正确手势打开页面菜单（分别覆盖滚动桌面端、滚动移动端、书页模式）。
- **SC-002**: 在包含边界位置样本的交互测试中，放大镜位置避让成功率达到 100%，即无放大镜超出当前 PageView 可视边界或遮挡鼠标焦点的情况。
- **SC-003**: 在放大镜开启场景下，100% 的测试用例可在 2x/3x/4x/5x 四档倍率中完成正确切换，且不存在超出范围的倍率状态。
- **SC-004**: 在菜单上下文展示测试中，针对“加载原图”“奇偶切换”“倍率调整”的显隐条件准确率达到 100%。
- **SC-005**: 在完整阅读回归中，书页模式非中央区域翻页成功率与改动前基线保持一致（允许误差不超过 2%）。
- **SC-006**: 在移动端手势验收中，按压不足 500ms 的触控事件误触发菜单比例低于 1%。
