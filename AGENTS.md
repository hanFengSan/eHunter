# AGENTS.md

本文件用于说明本仓库中 AI Agent / 自动化协作者 的工作边界与项目上下文，帮助在重构期间保持一致性。

## 项目概述

- 项目名称：eHunter
- 项目类型：面向 e-hentai 网站的油猴脚本插件
- 核心能力：解析原站 DOM，提取漫画图片地址，并渲染更友好的阅读体验
- 阅读模式：
  - 书页模式（Book Mode）
  - 卷轴模式（Scroll Mode）

## 当前状态

- 项目处于**重构阶段**，整体尚未完成。
- 重构与历史代码并存，修改前请先确认目标目录。
- 当前默认入口以测试挂载为主：`src/main.ts` 目前注入 `core/TestApp.vue` + `src/platform/test/AlbumService.ts`，真实站点注入逻辑仍在整理中。

## 目录职责约定

- `core/`：重构版本核心代码
- `src/`：重构版本业务与前端代码
- `core_old/`：旧版本核心代码（历史实现）
- `old/`：旧版本遗留代码（历史实现）

建议：

- 新功能、问题修复、结构优化优先落在 `core/` 与 `src/`。
- 若需参考旧实现，可阅读 `core_old/` 与 `old/`，但避免把历史结构直接复制回重构目录。

## 技术栈

- 构建工具：Vite
- 前端框架：Vue 3
- 样式：Less（历史）+ SCSS（当前 `core/` 中大量样式为 SCSS）
- 语言：TypeScript
- 构建形态：
  - 开发：`vite.config.ts`
  - 产物：`vite.config.prod.ts`（IIFE + `vite-plugin-css-injected-by-js`，用于脚本注入场景）

## 平台范围与重构优先级

- 目标站点不仅有 e-hentai/exhentai，代码中还包含 nhentai 平台实现（`src/platform/nh/`）。
- 若进行重构迁移，优先保证 **EH 平台链路可用**（`src/platform/eh/`），再处理 NH 平台一致性。
- `src/platform/base/` 为跨平台基础层（请求队列、重试、平台 fetch 适配），改动时需同步评估 EH/NH 两端影响。

## 协作原则（给 Agent）

- 在重构完成前，优先保证改动**可读、可迁移、可回退**。
- 涉及旧目录（`core_old/`, `old/`）的改动需明确目的（修复历史 bug / 对照迁移 / 文档补充）。
- 当前存在“新旧模块交叉依赖”现象（`src/` 仍引用部分 `core/` 产物），修改 import 路径时优先做最小改动，避免一次性大迁移。
- 涉及 DOM 解析逻辑时，优先关注：
  - 选择器稳定性
  - 异步加载场景
  - 页面结构变化下的容错
- 涉及阅读器渲染逻辑时，优先关注：
  - 书页模式与卷轴模式行为一致性
  - 图片加载与缓存策略
  - 渲染性能与滚动体验
- 涉及 EH 缓存/抓取链路（`AlbumCacheService`、`ImgUrlListParser`）时，额外注意：
  - 缩略图 Normal/Large 模式切换兼容
  - 本地缓存版本号变更带来的迁移与刷新行为
  - 并发请求队列与超时重试参数对稳定性的影响

## 调试与验证建议

- 与抓取、解析、缓存相关的改动，至少手动验证：
  - 首屏是否可正常拉取页数/标题/当前页
  - 书页模式与卷轴模式切换是否正常
  - 缩略图加载与定位是否正确
  - 原图/换源逻辑（若平台支持）是否可用
- 若修改平台基础请求层（`TextReq`/`ReqQueue`/`MultiAsyncReq`），优先在 EH 与 NH 两个平台链路都做回归。

## 提交建议

- 提交信息建议明确标注作用域，例如：
  - `refactor(core): ...`
  - `feat(src): ...`
  - `fix(platform-eh): ...`
  - `fix(platform-base): ...`
  - `fix(parser): ...`
- 对重构迁移类提交，建议在描述中附上“来源目录/目标目录/迁移原因”。
