# 目标
一个好用、美观、稳定的漫画阅读器（Userscript 注入形态）。

## 形态
- 仅 Userscript（Tampermonkey / Violentmonkey 等）
- 不支持 WebExtension 双形态

## 平台与优先级

### 平台优先级
1. EH 平台（`e-hentai.org` / `exhentai.org`）最高优先级
2. NH 平台（`nhentai`）次优先级

### 目标用户硬件平台
- Windows
- Mac
- Android
- iOS / iPadOS（无需单独运行时特化，仅保证窄屏展示适配）

### 浏览器
- Chrome
- Firefox
- Safari

## 用户页面与交互体验
- 使用自适应设计，兼容 PC 端与移动端窄屏访问
- 阅读器主体由统一页面组件体系驱动，滚动模式和书页模式共享单页渲染逻辑
- 书页模式翻页动效支持用户下拉配置：
  - 拟真翻页
  - 平移切屏
  - 无动效直接切页
- 默认动效策略：
  - PC / Mac：拟真翻页
  - 移动端：平移切屏

## 功能说明

### 基础功能
- 多网站信息解析（EH 优先，NH 次之）
- 通用本地持久化（LocalStorage）
- 通知弹窗支持 Markdown 渲染（文案由接口请求后传入组件）

### 跨平台统一契约（必须）
- 统一错误码体系（跨平台一致）
- 统一重试策略（跨平台一致）
- 统一缓存策略（跨平台一致）
- 平台特性能力开关（如原图、换源），能力不足时自动降级展示与交互

### 漫画单页渲染组件（PageView）
- 支持缩略图垫底
- 支持三类加载模式：
  - 默认刷新（同源）
  - 换源刷新（平台支持时）
  - 原图加载（平台支持时）
- 加载失败策略：
  1. 同源自动重试 3 次
  2. 若仍失败，按配置链路继续尝试换源与原图
- 换源/原图自动尝试为重构新特性：
  - 默认开启
  - 用户可主动关闭
- 比例策略：
  - 初始使用默认比例占位（`heightOfWidth`）
  - 加载后回填精确比例（`preciseHeightOfWidth`）并触发布局修正
- 未加载完成时，页面序号居中显示
- 滚动模式与书页模式统一复用该组件，加载与错误行为一致

### 滚动模式
- 支持配置页面宽度，调整单页显示大小
- 左侧默认显示缩略图预览栏；点击缩略图可滚动跳转
- 为避免卡顿，仅渲染当前页及上下邻近页内容
  - 邻近窗口由用户配置项 `loadNum` 决定
- 支持调整页面间距

### 书页模式
- 默认双页展示，支持调整每屏页数（如 1 页、多页）
- 书页模式以可视区域高度/宽度比计算每页尺寸，保证整屏阅读体验
- 支持全局奇偶偏移（用于跨页拼图内容校正）
- 支持书页模式缩略图侧栏开关：
  - 默认关闭
  - 用户可开启

## 配置与持久化

### 配置存储
- 使用 LocalStorage 作为配置持久化介质
- 配置项覆盖阅读模式、动效、缩略图开关、加载窗口大小、页面间距、语言等

### 配置迁移（重构阶段强约束）
- 必须支持无损迁移
- 新增配置项自动补默认值
- 废弃字段可清理或映射
- 迁移过程可回退、可追踪（建议保留配置版本号）

## 缓存策略
- 按平台统一缓存键规范与版本号机制
- 缓存命中/失效逻辑跨平台一致
- 平台实现可扩展，但不得破坏统一契约
- EH 链路的缓存稳定性优先保障

## 重构阶段协作约束
- 新功能、修复、优化优先落在 `core/` 与 `src/`
- `core_old/` 与 `old/` 仅作对照迁移参考，避免直接回拷旧结构
- 涉及平台基础请求层时，需评估 EH / NH 双端影响
- 涉及 DOM 解析时关注：
  - 选择器稳定性
  - 异步加载兼容
  - 页面结构变化容错

## 验收与回归建议

### EH 优先链路
- 首屏页数/标题/当前页解析正确
- 缩略图列表加载与定位正确
- 双模式切换行为一致且索引同步正确

### 单页加载链路
- 默认加载、同源重试 3 次、换源/原图降级链路可验证
- 比例回填后布局无明显抖动或错位
- 加载失败信息可见且交互可用

### 阅读体验
- 滚动模式邻近渲染窗口随 `loadNum` 生效
- 书页模式奇偶偏移（全局）生效
- 翻页动效下拉配置生效，默认值按端正确
- 移动窄屏下可正常阅读与交互
